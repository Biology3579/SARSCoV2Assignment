---
title: "SARSCoV2Analysis"
author: "Biology3579"
date: "2025-03-18"
output:
  pdf_document:
    latex_engine: xelatex
  html_document: default
geometry: left=0.5cm, right=1cm, top=1cm, bottom=2cm
mainfont: Arial
---
## R-set-up
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,       # Show R code in the document
  warning = FALSE,   # Suppress warnings
  message = FALSE    # Suppress messages
)
```

```{r renv-restore}
# Restoring project's environment 
renv::restore()
```

```{r packages, warning=FALSE}
# Source library loading fucntion
source(here::here("functions", "libraries.R"))
# Load necessary libraries
load_libraries()
```
## Introduction

Emerging pathogens like SARS-CoV-2 exhibit significant variation in fitness as they evolve, leading to differences in their spread and public health impact. Variants such as Alpha, Delta, and Omicron had differing growth rates and transmissibility, influencing pandemic dynamics. Quantifying these changes helps us understand variant dynamics and prepare for future outbreaks.

This analysis aims to:
- Understand differences between fitness advantage and reproduction number of variants.
- Estimate these metrics using genomics data.
- Reflect on how changes in these metrics influence epidemic control strategies.

---

## **Question 1: SARS-CoV-2 Major Lineages and Trends**

This includes
weekly counts of virus samples per lineage over time across
England collected as part of Sanger Institute COG-UK


Now, let‚Äôs import the Sanger Institute COG-UK

### **1.1 Load and Clean Data**

To simplify the long list of lineage names assigned by the Pango nomenclature, we group them into broader ‚Äòmajor lineages.‚Äô For this practical, we focus on variants that caused significant waves in the UK since late 2020. These include: Alpha (B.1.1.7), Delta (B.1.617.2), and various Omicron sublineages, including BA.1, BA.2, BA.4, BA.5, and XBB. We put variants from other lineage into the 'Other' category.

```{r load-raw-data}
# Load ... data
sanger_raw <- read.csv(here("data", "Genomes_per_week_in_England.csv"))
head(sanger_raw) #Check ...
```


```{r clean-sanger-data}
#Clean the raw data and save it separately
source(here("functions", "cleaning_and_curating.R"))
sanger_clean <- sanger_raw %>%
  clean_names() %>%  # Standardize column names to snake_case
  rename(
      collection_date = date,  # Rename date for consistency with other data sets
      major_lineage = lineage) %>% # Rename date for consistency with other data sets 
  remove_empty_entries() %>%
  mutate(
    collection_date = as.Date(collection_date),  # Ensure date is recognised as date
    major_lineage = as.character(major_lineage),  # Ensure lineage is character
    count = as.numeric(count)) %>%  # Ensure count is numeric
  classify_major_lineages(c("B.1.1.7", "B.1.617.2", "BA.1", "BA.2", "BA.2.75", "BA.4", "BA.5", "BA.5.3", "XBB"))

#Save data 
write_csv(sanger_clean, here("data", "sanger_clean.csv"))
```

### **1.2 Stacked Area Plots**

In order to ....
this fucntion does this ...
```{r curate-sanger-data}
source(here("functions", "cleaning_and_curating.R"))
# Prepare data
sanger_major_lineage_trends <- curate_lineage_trend_data(sanger_clean)
```


weekly...

```{r sanger-total-counts-plot}
source(here("functions", "plotting.R"))
# Generate the stacked area plots
plot_total_lineage_counts(sanger_major_lineage_trends)   # Total counts of each lineage over time

```

```{r sanger-frequencies-plot}
source(here("functions", "plotting.R"))
plot_lineage_frequencies(sanger_major_lineage_trends)  # Proportions of each lineage over time

```


---

## **Question 2: BA.2 Frequency Trajectory**

```{r load-raw-data}
# Import ONS-CIS daily genomic sequence data
onscis_raw <- read_csv("https://raw.githubusercontent.com/mg878/variant_fitness_practical/main/lineage_data.csv", 
                       show_col_types = FALSE) #to suppress the read_csv() message
# Save the dataset
write_csv(onscis_raw, here("data", "onscis_raw.csv"))

# Check the first few rows
head(onscis_raw)
```

```{r clean-onscis-data}
# Load cleaning functions
source(here("functions", "cleaning_and_curating.R"))

# Clean the raw data
onscis_clean <- onscis_raw %>%
  remove_empty_entries() %>%
  mutate(
    collection_date = as.Date(collection_date),  # Ensure collection date is formatted as Date
    major_lineage = as.character(major_lineage),  # Ensure lineage is character
    pangolin_call = as.character(pangolin_call)  # Keep pangolin_call as character
  )

# Save the cleaned data
write_csv(onscis_clean, here("data", "onscis_clean.csv"))

```

```{r curate-onscis-data}
source(here("functions", "cleaning_and_curating.R"))
# Generate count data, compute trends, and bin data (if needed)
onscis_binned <- onscis_clean %>%
  group_by(collection_date, major_lineage) %>%
  summarise(count = n(), .groups = "drop") %>%  # Generate count data
  curate_lineage_trend_data() %>%               # Compute lineage trends
  bin_lineage_data(bin_size = 10)               # Bin into 10-day intervals ...

```



## plot 
```{r ba2-frequency-trajectory}

# Extract BA.2 data from COG-UK dataset
ba2_cog <- sanger_major_lineage_trends %>%
  filter(major_lineage == "BA.2") %>%
  mutate(source = "COG-UK (Weekly)")

# Extract BA.2 data from ONS-CIS dataset
ba2_onscis <- onscis_binned %>%
  filter(major_lineage == "BA.2") %>%
  mutate(source = "ONS-CIS (10-day Binned)")


# Plot 
source(here("functions", "plotting.R"))
plot_ba2_frequency_comparison(ba2_cog, ba2_onscis)
```

# comment 
Analysis: compare the two trajectories. Is there a difference in the timing of BA.2‚Äôs rise and when it reaches fixation? Reflect on potential reasons for these differences
(sampling strategies and geographical or temporal biases in data collection)?



---

## **Question 3: Variant Fixation Analysis**
Question 3
Using the Sanger dataset, determine which variant‚ÄîB.1.617.2, BA.1, or BA.2‚Äîreached
fixation the fastest and exhibited the highest selective advantage under a logistic growth
model. Use weekly counts to measure the selective advantage (ùë†).

```{r logistic-growth}
# Logistic growth model
logistic_model <- function(data, lineage) {
  data <- filter(data, lineage == lineage)
  glm(formula = cbind(count, total - count) ~ week, data = data, family = binomial)
}

# Fit models
variants <- c("B.1.617.2", "BA.1", "BA.2")
models <- lapply(variants, function(v) logistic_model(genomes, v))
names(models) <- variants

# Compare selective advantage
s_values <- sapply(models, function(m) coef(m)[2])
s_values
```

---

## **Question 4: Regional Analysis of Delta Variant**

```{r delta-region-analysis}
# Load Delta dataset
delta_data <- readRDS("data/delta-d2.rds")
delta_data <- subset(delta_data, phecname != "")

# Delta frequencies by region
ggplot(delta_data, aes(x = week, y = prop, color = phecname)) +
  geom_line() +
  labs(title = "Delta Variant Frequency by Region", x = "Week", y = "Proportion", color = "Region") +
  theme_minimal()
```

---

## **Question 5: Delta Incidence and Rt Estimation**

```{r delta-incidence}
# Load daily cases
daily_cases <- read.csv("data/daily-new-confirmed-covid-19-cases.csv")

delta_incidence <- genomes_freq %>% 
  filter(lineage == "B.1.617.2") %>% 
  mutate(daily_cases = daily_cases$count * prop)

# Plot estimated daily cases
ggplot(delta_incidence, aes(x = week)) +
  geom_line(aes(y = daily_cases, color = "Estimated Delta Cases")) +
  geom_line(aes(y = count, color = "Sequenced Delta Cases")) +
  labs(title = "Estimated vs. Sequenced Delta Cases", x = "Week", y = "Cases", color = "Dataset") +
  theme_minimal()
```

```{r rt-calculation}
library(EpiEstim)

# Estimate Rt
rt_estimate <- estimate_R(delta_incidence$daily_cases, method = "parametric_si", config = make_config(mean_si = 4.7, std_si = 2.9))

# Plot Rt
ggplot(rt_estimate$R, aes(x = t_end, y = `Mean(R)`, ymin = `Quantile.025(R)`, ymax = `Quantile.975(R)`)) +
  geom_line() +
  geom_ribbon(alpha = 0.2) +
  labs(title = "Estimated Rt of Delta Variant", x = "Time", y = "Reproduction Number (Rt)") +
  theme_minimal()
```

---

## **Conclusions**

- The dataset provided insights into the dynamics of SARS-CoV-2 variants in England.
- The BA.2 variant trajectory differed between datasets, likely due to sampling strategies.
- The Delta variant exhibited regional variation in growth rates.
- The estimated Rt for Delta confirmed its rapid spread.