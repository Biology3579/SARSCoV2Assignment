---
title: "SARSCoV2Analysis"
author: "Biology3579"
date: "2025-03-18"
output:
  pdf_document:
    latex_engine: xelatex
  html_document: default
geometry: left=0.5cm, right=1cm, top=1cm, bottom=2cm
mainfont: Arial
---
## R-set-up
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,       # Show R code in the document
  warning = FALSE,   # Suppress warnings
  message = FALSE    # Suppress messages
)
```

```{r renv-restore}
# Restoring project's environment 
renv::restore()
```

```{r packages, warning=FALSE}
# Source library loading fucntion
source(here::here("functions", "libraries.R"))
# Load necessary libraries
load_libraries()
```
## Introduction

Emerging pathogens like SARS-CoV-2 exhibit significant variation in fitness as they evolve, leading to differences in their spread and public health impact. Variants such as Alpha, Delta, and Omicron had differing growth rates and transmissibility, influencing pandemic dynamics. Quantifying these changes helps us understand variant dynamics and prepare for future outbreaks.

This analysis aims to:
- Understand differences between fitness advantage and reproduction number of variants.
- Estimate these metrics using genomics data.
- Reflect on how changes in these metrics influence epidemic control strategies.

---

## **Question 1: SARS-CoV-2 Major Lineages and Trends**

This includes
weekly counts of virus samples per lineage over time across
England collected as part of Sanger Institute COG-UK


Now, let‚Äôs import the Sanger Institute COG-UK

### **1.1 Load and Clean Data**

To simplify the long list of lineage names assigned by the Pango nomenclature, we group them into broader ‚Äòmajor lineages.‚Äô For this practical, we focus on variants that caused significant waves in the UK since late 2020. These include: Alpha (B.1.1.7), Delta (B.1.617.2), and various Omicron sublineages, including BA.1, BA.2, BA.4, BA.5, and XBB. We put variants from other lineage into the 'Other' category.

```{r load-raw-data}
# Load ... data
sanger_raw <- read.csv(here("data", "Genomes_per_week_in_England.csv"))
head(sanger_raw) #Check ...
```


```{r clean-sanger-data}
#Clean the raw data and save it separately
source(here("functions", "cleaning_and_curating.R"))
sanger_clean <- sanger_raw %>%
  clean_names() %>%  # Standardize column names to snake_case
  rename(
      collection_date = date,  # Rename date for consistency with other data sets
      major_lineage = lineage) %>% # Rename date for consistency with other data sets 
  remove_empty_entries() %>%
  mutate(
    collection_date = as.Date(collection_date),  # Ensure date is recognised as date
    major_lineage = as.character(major_lineage),  # Ensure lineage is character
    count = as.numeric(count)) %>%  # Ensure count is numeric
  classify_major_lineages(c("B.1.1.7", "B.1.617.2", "BA.1", "BA.2", "BA.2.75", "BA.4", "BA.5", "BA.5.3", "XBB"))

#Save data 
write_csv(sanger_clean, here("data", "sanger_clean.csv"))
```

### **1.2 Stacked Area Plots**

In order to ....
this fucntion does this ...
```{r curate-sanger-data}
source(here("functions", "cleaning_and_curating.R"))
# Prepare data
sanger_major_lineage_trends <- curate_lineage_trend_data(sanger_clean)
```


weekly...

```{r sanger-total-counts-plot}
source(here("functions", "plotting.R"))
# Generate the stacked area plots
plot_total_lineage_counts(sanger_major_lineage_trends)   # Total counts of each lineage over time

```

```{r sanger-frequencies-plot}
source(here("functions", "plotting.R"))
plot_lineage_frequencies(sanger_major_lineage_trends)  # Proportions of each lineage over time

```


---

## **Question 2: BA.2 Frequency Trajectory**

```{r load-raw-data}
# Import ONS-CIS daily genomic sequence data
onscis_raw <- read_csv("https://raw.githubusercontent.com/mg878/variant_fitness_practical/main/lineage_data.csv", 
                       show_col_types = FALSE) #to suppress the read_csv() message
# Save the dataset
write_csv(onscis_raw, here("data", "onscis_raw.csv"))

# Check the first few rows
head(onscis_raw)
```

```{r clean-onscis-data}
# Load cleaning functions
source(here("functions", "cleaning_and_curating.R"))

# Clean the raw data
onscis_clean <- onscis_raw %>%
  remove_empty_entries() %>%
  mutate(
    collection_date = as.Date(collection_date),  # Ensure collection date is formatted as Date
    major_lineage = as.character(major_lineage),  # Ensure lineage is character
    pangolin_call = as.character(pangolin_call)  # Keep pangolin_call as character
  )

# Save the cleaned data
write_csv(onscis_clean, here("data", "onscis_clean.csv"))

```

```{r curate-onscis-data}
source(here("functions", "cleaning_and_curating.R"))
# Generate count data, compute trends, and bin data (if needed)
onscis_binned <- onscis_clean %>%
  group_by(collection_date, major_lineage) %>%
  summarise(count = n(), .groups = "drop") %>%  # Generate count data
  curate_lineage_trend_data() %>%               # Compute lineage trends
  bin_lineage_data(bin_size = 10)               # Bin into 10-day intervals ...

```



## plot 
```{r ba2-frequency-trajectory}

# Extract BA.2 data from COG-UK dataset
ba2_cog <- sanger_major_lineage_trends %>%
  filter(major_lineage == "BA.2") %>%
  mutate(source = "COG-UK (Weekly)")

# Extract BA.2 data from ONS-CIS dataset
ba2_onscis <- onscis_binned %>%
  filter(major_lineage == "BA.2") %>%
  mutate(source = "ONS-CIS (10-day Binned)")


# Plot 
source(here("functions", "plotting.R"))
plot_ba2_frequency_comparison(ba2_cog, ba2_onscis)
```

# comment 
Analysis: compare the two trajectories. Is there a difference in the timing of BA.2‚Äôs rise and when it reaches fixation? Reflect on potential reasons for these differences
(sampling strategies and geographical or temporal biases in data collection)?



---

## **Question 3: Variant Fixation Analysis**
Question 3
Using the Sanger dataset, determine which variant‚ÄîB.1.617.2, BA.1, or BA.2‚Äîreached
fixation the fastest and exhibited the highest selective advantage under a logistic growth model. 
Use weekly counts to measure the selective advantage (ùë†).

Discussion...

```{r estimate-delta-growth-part1, echo=TRUE, message=FALSE, warning=FALSE}
# Filter the Sanger dataset for the three variants
sanger_selected_variants <- sanger_major_lineage_trends %>%
  filter(major_lineage %in% c("B.1.617.2", "BA.1", "BA.2"))

# Plot frequency trajectories for the selected variants
ggplot(sanger_selected_variants, aes(x = collection_date, y = lineage_frequency, color = major_lineage)) +
  geom_line(linewidth = 1.2) +  # Line for trends
  geom_point(size = 2, alpha = 0.7) +  # Points for visibility
  scale_color_manual(values = c("B.1.617.2" = "#E69F00",   # Orange
                                "BA.1" = "#009E73",        # Green
                                "BA.2" = "#D55E00")) +     # Red
  labs(
    title = "Frequency Trajectories of B.1.617.2, BA.1, and BA.2",
    x = "Collection Date",
    y = "Frequency",
    color = "Variant"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# Extract growth phase dates for each variant
growth_phases <- bind_rows(
  extract_growth_phase_dates(sanger_major_lineage_trends, "B.1.617.2"),
  extract_growth_phase_dates(sanger_major_lineage_trends, "BA.1"),
  extract_growth_phase_dates(sanger_major_lineage_trends, "BA.2")
)

print(growth_phases)

```


```{r, warning=FALSE}
B16172_growth_phase <- sanger_major_lineage_trends %>%
  filter(
    major_lineage == "B.1.617.2",  # Select Delta variant
    collection_date >= as.Date("2021-03-27") & collection_date <= as.Date("2021-06-19")  # Growth phase interval
  )
# Define Logistic Growth Function (Ensure this is run first)
logistic_growth <- function(t, s, f0) {
  1 / (1 + ((1 - f0) / f0) * exp(-s * t))
}


# Fit the logistic model using nls
nls_fit <- nls( # this is ...
  lineage_frequency ~ logistic_growth(as.numeric(collection_date - min(collection_date)), s, f0),
  data = B16172_growth_phase,
  start = list(s = 0.1, f0 = min(B16172_growth_phase$lineage_frequency))  # Initial guesses to make it easier for r to find
  #value = first non-zero value of strain
)

# Extract fitted growth rate
growth_rate <- coef(nls_fit)["s"]

# Generate a smooth sequence of dates for plotting the logistic curve
smooth_dates <- seq(min(B16172_growth_phase$collection_date),
                    max(B16172_growth_phase$collection_date), by = "1 day")

# Calculate predicted frequencies for smooth (continuous) dates 
smooth_predictions <- data.frame(
  collection_date = smooth_dates,
  predicted_frequency = logistic_growth(as.numeric(smooth_dates - min(B16172_growth_phase$collection_date)),
                                         coef(nls_fit)["s"], coef(nls_fit)["f0"])
)

# Visualise the actual data points and the smooth logistic fit
ggplot(B16172_growth_phase, aes(x = collection_date)) +
  geom_point(aes(y = lineage_frequency), color = "black", size = 2, alpha = 0.7) +
  geom_line(data = smooth_predictions, aes(x = collection_date, y = predicted_frequency), color = "orange", size = 1) +
  annotate(
    "text", 
    x = as.Date("2021-05-15"), 
    y = 0.8, 
    label = paste0("s= ", round(growth_rate, 4)), 
    color = "orange", 
    size = 5
  ) +
  labs(
    title = "Logistic growth fit for Delta variant frequency",
    x = "Collection date",
    y = "Frequency"
  ) +
  theme_minimal()
```
```{r, warning=FALSE}
# Subset data to only include the increasing trajectory for BA.1
BA1_growth_phase <- sanger_major_lineage_trends %>%
  filter(major_lineage == "BA.1", 
         collection_date >= as.Date("2021-10-30") & collection_date <= as.Date("2022-01-08"))

# Define Logistic Growth Function (Ensure this is run first)
logistic_growth <- function(t, s, f0) {
  1 / (1 + ((1 - f0) / f0) * exp(-s * t))
}

# Fit the logistic model using nls
nls_fit <- nls( 
  lineage_frequency ~ logistic_growth(as.numeric(collection_date - min(collection_date)), s, f0),
  data = BA1_growth_phase,
  start = list(s = 0.1, f0 = min(BA1_growth_phase$lineage_frequency[BA1_growth_phase$lineage_frequency > 0])) # Avoid zero for f0
)

# Extract fitted growth rate
growth_rate <- coef(nls_fit)["s"]

# Generate a smooth sequence of dates for plotting the logistic curve
smooth_dates <- seq(min(BA1_growth_phase$collection_date),
                    max(BA1_growth_phase$collection_date), by = "1 day")

# Calculate predicted frequencies for smooth (continuous) dates 
smooth_predictions <- data.frame(
  collection_date = smooth_dates,
  predicted_frequency = logistic_growth(as.numeric(smooth_dates - min(BA1_growth_phase$collection_date)),
                                         coef(nls_fit)["s"], coef(nls_fit)["f0"])
)

# Visualise the actual data points and the smooth logistic fit
ggplot(BA1_growth_phase, aes(x = collection_date)) +
  geom_point(aes(y = lineage_frequency), color = "black", size = 2, alpha = 0.7) +
  geom_line(data = smooth_predictions, aes(x = collection_date, y = predicted_frequency), color = "red", size = 1) +
  annotate(
    "text", 
    x = as.Date("2021-12-15"), 
    y = 0.8, 
    label = paste0("s= ", round(growth_rate, 4)), 
    color = "red", 
    size = 5
  ) +
  labs(
    title = "Logistic growth fit for BA.1 variant frequency",
    x = "Collection date",
    y = "Frequency"
  ) +
  theme_minimal()

```

	
```{r, warning=FALSE}
# Subset data to only include the increasing trajectory for BA.1
BA2_growth_phase <- sanger_major_lineage_trends %>%
  filter(major_lineage == "BA.2", 
         collection_date >= as.Date("2021-01-01") & collection_date <= as.Date("2022-04-16"))

# Define Logistic Growth Function (Ensure this is run first)
logistic_growth <- function(t, s, f0) {
  1 / (1 + ((1 - f0) / f0) * exp(-s * t))
}

# Fit the logistic model using nls
nls_fit <- nls( 
  lineage_frequency ~ logistic_growth(as.numeric(collection_date - min(collection_date)), s, f0),
  data = BA2_growth_phase,
  start = list(s = 0.1, f0 = min(BA2_growth_phase$lineage_frequency[BA2_growth_phase$lineage_frequency > 0])) # Avoid zero for f0
)

# Extract fitted growth rate
growth_rate <- coef(nls_fit)["s"]

# Generate a smooth sequence of dates for plotting the logistic curve
smooth_dates <- seq(min(BA2_growth_phase$collection_date),
                    max(BA2_growth_phase$collection_date), by = "1 day")

# Calculate predicted frequencies for smooth (continuous) dates 
smooth_predictions <- data.frame(
  collection_date = smooth_dates,
  predicted_frequency = logistic_growth(as.numeric(smooth_dates - min(BA2_growth_phase$collection_date)),
                                         coef(nls_fit)["s"], coef(nls_fit)["f0"])
)

# Visualise the actual data points and the smooth logistic fit
ggplot(BA2_growth_phase, aes(x = collection_date)) +
  geom_point(aes(y = lineage_frequency), color = "black", size = 2, alpha = 0.7) +
  geom_line(data = smooth_predictions, aes(x = collection_date, y = predicted_frequency), color = "red", size = 1) +
  annotate(
    "text", 
    x = as.Date("2021-01-01"), 
    y = 0.8, 
    label = paste0("s= ", round(growth_rate, 4)), 
    color = "red", 
    size = 5
  ) +
  labs(
    title = "Logistic growth fit for BA.1 variant frequency",
    x = "Collection date",
    y = "Frequency"
  ) +
  theme_minimal()

```

B.1.617.2	2021-04-03	2021-06-19		
BA.1	2021-10-30	2022-01-08		
BA.2	2022-01-01	2022-04-16	


```{r logistic-growth}
# Logistic growth model
logistic_growth <- function(t, s, f0) {
  1 / (1 + ((1 - f0) / f0) * exp(-s * t))
}

# Fit logistic growth model for each variant using inline date definitions
growth_rates <- bind_rows(
  fit_variant_growth(sanger_major_lineage_trends, "B.1.617.2", start_date = as.Date("2021-04-03"), end_date = as.Date("2021-06-19")),
  fit_variant_growth(sanger_major_lineage_trends, "BA.1", start_date = as.Date("2021-10-30"), end_date = as.Date("2022-01-08")),
  fit_variant_growth(sanger_major_lineage_trends, "BA.2", start_date = as.Date("2022-01-01"), end_date = as.Date("2022-04-16"))
)
print(growth_rates)

# Define known growth intervals
growth_intervals <- tibble(
  variant = c("B.1.617.2", "BA.1", "BA.2"),
  start_date = as.Date(c("2021-04-23", "2021-11-05", "2022-02-15")),
  end_date = as.Date(c("2021-07-12", "2022-01-30", "2022-04-25")),
  color = c("#E69F00", "#009E73", "#D55E00")  # Color for each variant
)

# Fit logistic models for all variants
growth_results_list <- growth_intervals %>%
  rowwise() %>%
  mutate(growth_results = list(fit_variant_growth(sanger_major_lineage_trends, variant, start_date, end_date)))

# Generate plots
growth_plots <- pmap(list(
  growth_results_list$growth_results,
  growth_intervals$variant,
  growth_intervals$color
), plot_logistic_growth_curve)

# Arrange plots side by side
ggarrange(plotlist = growth_plots, ncol = 3, nrow = 1)
```

---

## **Question 4: Regional Analysis of Delta Variant**

```{r delta-region-analysis}
# Load Delta dataset
delta_data <- readRDS("data/delta-d2.rds")
delta_data <- subset(delta_data, phecname != "")

# Delta frequencies by region
ggplot(delta_data, aes(x = week, y = prop, color = phecname)) +
  geom_line() +
  labs(title = "Delta Variant Frequency by Region", x = "Week", y = "Proportion", color = "Region") +
  theme_minimal()
```

---

## **Question 5: Delta Incidence and Rt Estimation**

```{r delta-incidence}
# Load daily cases
daily_cases <- read.csv("data/daily-new-confirmed-covid-19-cases.csv")

delta_incidence <- genomes_freq %>% 
  filter(lineage == "B.1.617.2") %>% 
  mutate(daily_cases = daily_cases$count * prop)

# Plot estimated daily cases
ggplot(delta_incidence, aes(x = week)) +
  geom_line(aes(y = daily_cases, color = "Estimated Delta Cases")) +
  geom_line(aes(y = count, color = "Sequenced Delta Cases")) +
  labs(title = "Estimated vs. Sequenced Delta Cases", x = "Week", y = "Cases", color = "Dataset") +
  theme_minimal()
```

```{r rt-calculation}
library(EpiEstim)

# Estimate Rt
rt_estimate <- estimate_R(delta_incidence$daily_cases, method = "parametric_si", config = make_config(mean_si = 4.7, std_si = 2.9))

# Plot Rt
ggplot(rt_estimate$R, aes(x = t_end, y = `Mean(R)`, ymin = `Quantile.025(R)`, ymax = `Quantile.975(R)`)) +
  geom_line() +
  geom_ribbon(alpha = 0.2) +
  labs(title = "Estimated Rt of Delta Variant", x = "Time", y = "Reproduction Number (Rt)") +
  theme_minimal()
```

---

## **Conclusions**

- The dataset provided insights into the dynamics of SARS-CoV-2 variants in England.
- The BA.2 variant trajectory differed between datasets, likely due to sampling strategies.
- The Delta variant exhibited regional variation in growth rates.
- The estimated Rt for Delta confirmed its rapid spread.